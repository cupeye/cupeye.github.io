<!doctype html>
<!--[if lt ie 7]>      <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if ie 7]>         <html class="lt-ie9 lt-ie8 ie7"> <![endif]-->
<!--[if ie 8]>         <html class="lt-ie9 ie8"> <![endif]-->
<!--[if gt ie 8]><!-->
<html class=""><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spoqa Tech Blog | Java의 json 라이브러리 google-gson</title>
  <link rel="canonical" href="https://spoqa.github.io/2012/01/09/using-gson-in-android.html">
  <meta property="og:title" content="Java의 json 라이브러리 google-gson">
  <meta property="og:url" content="https://spoqa.github.io/2012/01/09/using-gson-in-android.html">
  <meta property="og:site_name" content="컵아이">
  
  
  <meta property="og:type" content="article">
  <meta property="og:description" content="안드로이드 주소록을 다루며 애먹었던 경험을 소개하고 간단하게 json라이브러리 google-gson 사용법을 소개합니다.">
  
  
  <script>
    window.WebFontConfig = {
        custom: {
            families: ['spoqahansans:100,400,700'],
            urls: ['/css/spoqahansans.css']
        },
        timeout: 60000
    };
    (function(d) {
        var wf = d.createElement('script'), s = d.scripts[0];
        wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js';
        s.parentNode.insertBefore(wf, s);
    })(document);
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-36136046-5', 'auto');
    ga('send', 'pageview');
  </script>
  <link rel="stylesheet" href="../../../css/styles.css">
  <link href="../../../atom.xml" type="application/atom+xml" rel="alternate" title="Spoqa 기술 블로그">
  <link rel="shortcut icon" href="../../../images/favicon.ico">
  <style type="text/css">
@media only screen and (max-width: 580px) {
  .btn-job {
    display: none;
  }
}
</style>
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <div class="header-item">
        <div class="spoqa-logo-wrap">
          <a class="spoqa-logo" href="../../../"><img style="margin-top:-20px" src="../../../images/logo.png" alt="Spoqa logo"></a>
          <a class="blog-title" href="../../../">컵아이</a>
        </div>
        <div class="nav">
          <input type="checkbox" id="toggle">
          <label for="toggle" class="toggle" onclick></label>
          <ul class="menu">
            <li><a class="selected menu-about" href="../../../about.html">소개</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content">
      


<div class="post-author-info">
  
    <img class="portrait" src="../../../images/profile/akaz@spoqa.com.png" />
    <h1 class="post-title">Java의 json 라이브러리 google-gson</h1>
    <span class="post-date">2012년 01월 09일</span>
    <span class="sep">|</span>
    <span class="author-name"><a href="mailto:akaz@spoqa.com">akaz</a></span>
  
</div>



  <div class="post"><h2 id="section">문제 상황</h2>
<hr />

<p>안드로이드 어플리케이션을 개발하다 보면 주소록을 다루는 일이 종종 있습니다. 어플리케이션에서 주소록에 관련된 정보를 접근할 일이 있는 어플이라면 <a href="http://developer.android.com/reference/android/content/ContentResolver.html">ContentResolver</a>를 통해 단말의 주소록에 접근해서 필요한 정보를 가져오게 됩니다.</p>

<p>그런데, 최근 개발하고 있는 <a href="http://spo.qa/get">스포카</a> 어플을 통해 아주 많은 사람의 연락처가 저장된 주소록을 가지고 이런 저런 로직을 실행하는 상황을 테스트 하다보니, <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OutOfMemory(OOM)</a>에러가 발생하는 현상을 볼 수 있었습니다. 모바일 디바이스들은 PC와 다르게 자원이 제한적이기 때문에 어떻게 하면 <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OOM</a>을 일으키지 않을 수 있을까 라는 고민을 해야 하는 상황이었습니다.</p>

<p>대강 문제가 되었던 클라이언트 사이드의 로직을 살펴보면 이렇습니다.</p>

<ol>
  <li>단말의 주소록에 접근하여 필요한 정보를 추출 후 서버에 전송</li>
  <li>서버에서 정보를 가공하여 필요한 <a href="http://www.json.org">json</a> 문자열을 생성 후 반환, 이 문자열은 주소록에서 보낸 정보의 양에 비례해서 늘어나게 됩니다.</li>
  <li>클라이언트 측에서 서버 측에서 보낸 <a href="http://www.json.org">json</a> 문자열을 이용하여 <a href="http://developer.android.com/reference/org/json/JSONObject.html">JSONObject</a>객체를 만든 후 이 <a href="http://developer.android.com/reference/org/json/JSONObject.html">JSONObject</a>를 이용 리스트 완성</li>
</ol>

<p><a href="http://www.eclipse.org">eclipse</a>의 <a href="http://eclipse.org/mat/">MAT(Memory Analyzer)</a>을 이용하여 어느 시점에서 <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OOM</a>이 일어나는지를 추측해보았습니다. 서버에서 보내준 <a href="http://www.json.org">json</a>형식의 문자열을 <a href="http://developer.android.com/reference/java/net/HttpURLConnection.html">HttpURLConnection</a>을 통해 전달받고 이를 <a href="http://developer.android.com/reference/java/lang/StringBuilder.html">StringBuilder</a>를 이용하여 완전한 문자열으로 만들던 도중에 <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OOM</a>이 일어나는 것으로 의심되었는데 이 때문에 <a href="http://developer.android.com/reference/org/json/JSONObject.html">JSONObject</a>의 생성자에 <a href="http://www.json.org">json</a> 문자열을 전달하기도 전에 메모리가 가득 차 버리니 매우 난감한 상황이었습니다.</p>

<p>대게 주소록에 사람이 그렇게 많지 않으므로 (200~500명 정도) 아무런 문제가 없었지만 10000명 정도의 더미데이터를 주소록에 저장하고 테스트하다 보니 append 메서드를 호출하다 <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OOM</a>에러를 뱉으면서 어플이 종료되었습니다. 문제는 append 메서드를 호출 시 <a href="http://developer.android.com/reference/java/lang/StringBuilder.html">StringBuilder</a>의 capacity를 넘을 경우 내부적으로는 메모리 재할당과 copy과정이 일어난다는 것이었습니다. 그렇다고 초기 <a href="http://developer.android.com/reference/java/lang/StringBuilder.html">StringBuilder</a>생성시 capacity를 무작정 높게 잡기도 애매한 상황이었습니다.</p>

<h2 id="gson">gson</h2>
<hr />

<p><a href="http://code.google.com/p/google-gson/">gson</a>은 Java객체를 <a href="http://www.json.org">json</a>형식으로 변환하고 그 역으로도 변환할 수 있도록 도와주는 라이브러리입니다. <a href="http://code.google.com/p/google-gson/">gson</a>의 사용법이 궁금하다면 <a href="https://sites.google.com/site/gson/gson-user-guide">gson user guide</a>를 읽어보면 되고 api가 궁금하다면 <a href="http://google-gson.googlecode.com/svn/trunk/gson/docs/javadocs/index.html">gson api document</a>를 참조하면 됩니다.</p>

<h2 id="gson-">gson 적용</h2>
<hr />

<script src="https://gist.github.com/1580601.js?file=gistfile1.py">  </script>

<p>대략 이런 방식으로 프로젝트에 <a href="http://code.google.com/p/google-gson/">gson</a>라이브러리를 적용하였고, <a href="http://developer.android.com/reference/java/net/HttpURLConnection.html">HttpURLConnection</a>을 통해 받아온 <a href="http://developer.android.com/reference/java/io/InputStream.html">InputStream</a>을 이용 바로 객체를 생성할 수 있었습니다. 이전에 <a href="http://developer.android.com/reference/java/lang/StringBuilder.html">StringBuilder</a>를 이용할때 생기는 오버헤드가 사라진 셈이죠. 위와 같은 방식으로 <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OOM</a>이 생기는 문제 상황을 해결 할 수 있었습니다.</p>

<p>위의 예는 상황을 최대한 단순화하여 설명하려고 작성한 예제이고 이 <a href="http://www.softwarepassion.com/android-series-parsing-json-data-with-gson/">사이트</a>를 통해 더 상세하게 설명된 사용예를 보실 수 있습니다.</p>

</div>


<div class="post-footer">
  <div class="back-btn"><a href="/">목록으로 돌아가기</a></div>
  <div class="fb-like" data-href="https://spoqa.github.io/2012/01/09/using-gson-in-android.html" data-layout="button_count" data-width="" data-share="false" data-show-faces="false"></div>
  <div class="fb-comments" data-href="https://spoqa.github.io/2012/01/09/using-gson-in-android.html" data-num-posts="5" data-width=""></div>
  <div id="fb-root"></div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function(event) {
    $('.fb-like, .fb-comments').attr('data-width', "100%");
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ko_KR/all.js#xfbml=1&appId=207542736008055";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
});
</script>
<style>
.hiring-banner {
  height: 320px;
  background-position-y: 80%;
}
.hiring-subtitle
{
  display: none;
}
.btn-job{
  margin-top: 4px;
}
@media only screen and (max-width: 360px) {
  .hiring-banner {
    height: 220px;
  }
}
}
</style>

    </div>
    <div class="push">
    </div>
    <div class="footer">
      <div id="info">
        <span>© <a href="http://cupeye.com/">컵아이</a> Inc. All rights reserved.</span>
        <span>Powered by <a href="https://pages.github.com/">GitHub Pages</a>.</span>
      </div>
    </div>
  </div>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="../../../js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    $(function() {
      $('.hiring-banner').bind("click", function() {
        location.href = '/jobs.html';
      });
      $('.toggle').bind("touchstart", function() {
        $('.menu').toggle();
      })
    });
  </script>
  <!-- Responsive layout polyfill for IE8 and lower -->
  <!--[if lte IE 8]>
  <script>
    var config = {
        mobileResponsiveBreakpoint: 650
    };
    $(window).on('resize', function(){
        if ($(window).width() <= config.mobileResponsiveBreakpoint) {
           !$(document.body).hasClass('res-mobile')) {
            $(document.body).addClass('res-mobile');
        } else {
            $(document.body).removeClass('res-mobile');
        }
    }).trigger('resize');
  </script>
  <![endif]-->
</body>
</html>
