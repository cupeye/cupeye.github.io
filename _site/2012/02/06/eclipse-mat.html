<!doctype html>
<!--[if lt ie 7]>      <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if ie 7]>         <html class="lt-ie9 lt-ie8 ie7"> <![endif]-->
<!--[if ie 8]>         <html class="lt-ie9 ie8"> <![endif]-->
<!--[if gt ie 8]><!-->
<html class=""><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spoqa Tech Blog | Eclipse Memory Analyzer 소개</title>
  <link rel="canonical" href="https://spoqa.github.io/2012/02/06/eclipse-mat.html">
  <meta property="og:title" content="Eclipse Memory Analyzer 소개">
  <meta property="og:url" content="https://spoqa.github.io/2012/02/06/eclipse-mat.html">
  <meta property="og:site_name" content="컵아이">
  
  
  <meta property="og:type" content="article">
  <meta property="og:description" content="Eclipse Memory Analyzer(MAT)을 소개하고 유용하게 쓸 수 있는 기능들을 알아봅니다.">
  
  
  <script>
    window.WebFontConfig = {
        custom: {
            families: ['spoqahansans:100,400,700'],
            urls: ['/css/spoqahansans.css']
        },
        timeout: 60000
    };
    (function(d) {
        var wf = d.createElement('script'), s = d.scripts[0];
        wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js';
        s.parentNode.insertBefore(wf, s);
    })(document);
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-36136046-5', 'auto');
    ga('send', 'pageview');
  </script>
  <link rel="stylesheet" href="../../../css/styles.css">
  <link href="../../../atom.xml" type="application/atom+xml" rel="alternate" title="Spoqa 기술 블로그">
  <link rel="shortcut icon" href="../../../images/favicon.ico">
  <style type="text/css">
@media only screen and (max-width: 580px) {
  .btn-job {
    display: none;
  }
}
</style>
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <div class="header-item">
        <div class="spoqa-logo-wrap">
          <a class="spoqa-logo" href="../../../"><img style="margin-top:-20px" src="../../../images/logo.png" alt="Spoqa logo"></a>
          <a class="blog-title" href="../../../">컵아이</a>
        </div>
        <div class="nav">
          <input type="checkbox" id="toggle">
          <label for="toggle" class="toggle" onclick></label>
          <ul class="menu">
            <li><a class="selected menu-about" href="../../../about.html">소개</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content">
      


<div class="post-author-info">
  
    <img class="portrait" src="../../../images/profile/akaz@spoqa.com.png" />
    <h1 class="post-title">Eclipse Memory Analyzer 소개</h1>
    <span class="post-date">2012년 02월 06일</span>
    <span class="sep">|</span>
    <span class="author-name"><a href="mailto:akaz@spoqa.com">akaz</a></span>
  
</div>



  <div class="post"><p>안드로이드 개발을 하다보면 종종 <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OutOfMemory(OOM)</a>에러를 만나게 됩니다. <a href="https://spoqa.github.io/2012/01/09/using-gson-in-android.html">이전에 올렸던 포스팅</a>에서도 이 문제로 고생을 했는데요, 메모리 누수 관련 문제는 로직 에러와는 달라서 찾기가 매우 난감한 경우가 많습니다. 이러한 메모리 누수 관련 문제를 해결하기 위한 검사 기능을 제공하는 무료 툴이 있습니다. 바로 <a href="http://eclipse.org/mat/">Eclipse MAT(Memory Analyzer)(MAT)</a>입니다.</p>

<p><img src="/images/eclipse-mat/mat_thumb.png" alt="Eclipse MAT" /></p>

<h2 id="eclipse-mat">Eclipse MAT</h2>
<hr />
<p><a href="http://eclipse.org/mat/">MAT</a>은 사용자로 하여금 힙 메모리의 상황을 파악하게 해주어 메모리 누수 현상과 필요없는 메모리 할당을 감지할 수 있도록 도와줍니다. 또한 자동으로 보고서를 작성하여 어떤 객체들이 메모리 누수를 일으키는지에 대한 추측을 해주는 기능을 제공합니다. <a href="http://eclipse.org/mat/">MAT</a>은 <a href="http://www.eclipse.org/">Eclipse</a> 플러그인이기 때문에 사용하려면 Eclipse가 깔려 있어야 합니다. <a href="http://eclipse.org/mat/">MAT</a>을 설치하려면 <a href="http://eclipse.org/mat/downloads.php">MAT 다운로드 페이지</a>에서 자신의 Eclipse버전에 맞는 파일을 받으시면 됩니다.</p>

<h2 id="how-to-use-mat">How to use MAT</h2>
<hr />
<p>MAT을 설치하였다면 Eclipse화면에서 MAT관련 탭이 뜹니다. 탭을 클릭 하고</p>

<pre><code>File -&gt; Open Heap Dump
</code></pre>

<p>를 누르면 힙 상황이 기록 된 <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>파일을 읽어올 수 있습니다.</p>

<p><img src="/images/eclipse-mat/mat_tab.png" alt="MAT tab" />
<img src="/images/eclipse-mat/open_heapdump.png" alt="Open Heap Dump" /></p>

<p>탭이 뜨지 않는다면</p>

<pre><code>Window -&gt; Open Perspective -&gt; Other에서 Memory Analysis
</code></pre>

<p>를 누르면 탭이 뜨는 것을 볼 수 있습니다.</p>

<p><img src="/images/eclipse-mat/perspective_memory_analysis.png" alt="perspective" /></p>

<p><a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a> 파일을 읽어오면 분석을 시작하고 결과를 Overview 화면에 보여줍니다.</p>

<p><img src="/images/eclipse-mat/overview.png" alt="Overview screen" /></p>

<p>파이 차트의 각 부분에 마우스를 갖다 대면 옆의 Inspector 화면에 해당 객체의 정보를 보여주는 것을 볼 수 있습니다.</p>

<h3 id="inspector">Inspector</h3>
<hr />
<p>Inspector 창에서는 선택된 객체의 내용을 볼 수 있습니다. 해당 객체의 클래스명과 패키지 명 그리고 해당 객체가 가지고 있었던 변수의 내용을 살펴볼 수 있습니다.</p>

<h3 id="section">유용한 기능들</h3>
<hr />
<p><a href="http://eclipse.org/mat/">MAT</a>에서 가장 중요하게 살펴볼 기능이라고 한다면 Leak suspoect report와 Dominator tree라고 볼 수 있습니다. Leak suspect와 Dominator tree 둘 다 가장 메모리를 많이 차지하고 있는 객체에 대한 정보를 제공합니다.</p>

<p><img src="/images/eclipse-mat/overview_useful_method.png" alt="Useful feature" /></p>

<h4 id="leak-suspect">Leak suspect</h4>
<hr />

<p><img src="/images/eclipse-mat/leak_suspect.png" alt="Leak suspect" /></p>

<p>Leak suspect는 가장 큰 용량을 차지하고 있는 객체들을 좀 더 세분된 파이 도표로 보여줍니다. Problem suspect 1을 보면 현재 이 스레드 객체의 크기가 전체 힙 메모리의 크기 중 19.73%를 점유하고 있다는 것을 알 수 있습니다. 전체의 20% 가까이 차지하고 있다는 것은 이 객체를 <a href="http://developer.android.com/reference/java/lang/OutOfMemoryError.html">OOM</a>의 범인(?)이라고 생각할 근거가 됩니다. 해당 객체에 대한 더 자세한 정보를 얻고 싶다면 Details을 클릭하면 됩니다.</p>

<h4 id="dominator-tree">Dominator tree</h4>
<hr />
<p>Dominator tree를 띄우면 현재 덤프 된 매모리 스냅 샷 중 가장 큰 용량을 차지하고 있는 객체 순으로 정렬하여 보여줍니다. Leak suspect와 비슷해 보이지만 더 구체적인 정보를 제공한다는 점이 다릅니다. 따라서 Leak suspect로 현 상황에 대한 힌트를 얻은 후 Dominator tree에서 디테일하게 살펴보는 것이 시간을 절약하는 방법입니다.</p>

<p><img src="/images/eclipse-mat/dominator_tree.png" alt="Dominator tree" /></p>

<p>상위에 있는 몇몇 객체들이 가장 의심 되는 객체들이라고 볼 수 있겠습니다. 왼쪽의 화살표를 클릭함으로써 그 객체가 참조하고 있는 다른 객체들에 대한 정보들을 볼 수 있습니다. 각 객체를 클릭하면 옆에 Inspect창의 내용이 달라지는 것을 볼 수 있습니다.</p>

<p>실제 이 스냅 샷은 <a href="https://spoqa.github.io/2012/01/09/using-gson-in-android.html">이전 포스팅의 문제</a>를 해결하려고 떠놓은 스냅 샷인데요, 이 결과를 보고 많은 메모리가 네트워크를 통해 받아오는 스트림을 처리하고 문자열로 가공하는데에 낭비되고 있다는 생각이 들어 다른 방법으로 우회하는 방법을 썼고 결과적으로 문제를 해결 할 수 있었습니다.</p>

<h2 id="android-mat">Android에서 MAT사용법</h2>
<hr />
<p>먼저 안드로이드 기기에서 힙 덤프를 수행하여 <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>파일을 생성해야 합니다. <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>파일을 생성하기 위해서 간단하게 취할 수 있는 2가지 방법이 있습니다.</p>

<h3 id="ddms--">1. DDMS를 이용한 추출</h3>
<hr />
<p>Eclipse의 <a href="http://developer.android.com/guide/developing/debugging/ddms.html">DDMS</a>를 이용하여 힙 덤프를 추출할 수 있습니다. 아 방법을 쓰려면 앱의 메니페스트 파일에 <a href="http://developer.android.com/reference/android/Manifest.permission.html#WRITE_EXTERNAL_STORAGE">WRITE_EXTERNAL_STORAGE 권한</a>을 부여해야 하며, sdcard에 쓸 수 있는 권한이 있어야 합니다. 이 방법을 통해 sdcard경로에 앱 패키지명의 <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>파일이 생성됩니다.</p>

<p><img src="/images/eclipse-mat/ddms_heapdump.png" alt="DDMS Heap Dump" /></p>

<h3 id="heap-dump-method">2. Heap dump method</h3>
<hr />
<p>안드로이드 API에서 제공하는 메서드 중에 <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>파일을 생성하는 메서드인 <a href="http://developer.android.com/reference/android/os/Debug.html#dumpHprofData(java.lang.String\)">dumpHprofData</a>가 있습니다. 이 메서드는 <a href="http://developer.android.com/reference/android/os/Debug.html">Debug</a> 클래스의 메서드인 것을 알 수 있는데, 이 <a href="http://developer.android.com/reference/android/os/Debug.html">Debug</a> 클래스에는 앱의 상태를 점검할 수 있는 여러 유용한 메서드가 있으므로 나중에 필요하면 사용할 수 있도록 익혀두면 좋습니다.</p>

<h3 id="android-hporf--">Android hporf 파일 변환</h3>
<hr />
<p>앞서 설명한 방법을 적용하여 <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>파일을 추출하였어도 안드로이드에서 추출한 <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>파일은 <a href="http://eclipse.org/mat/">MAT</a>에서 받아들이는 일반적인 <a href="http://java.sun.com/developer/technicalArticles/Programming/HPROF.html">hprof</a>포맷과 다르기 때문에 먼저 변환하는 과정이 필요합니다. 이러한 기능을 제공하는 것이 기본 SDK에 포함된 hprof-conv유틸입니다. 이 유틸은 SDK폴더 내의 tools폴더 안에 있는데 사용하려면 콘솔에서</p>

<pre><code>$ hprof-conv &lt;안드로이드용 hprof 파일&gt; &lt;변환할 hprof 파일&gt;
</code></pre>

<p>를 치시면 됩니다. 이제 변환된 파일을 MAT에서 열면 분석을 하실 수 있습니다.</p>

<h2 id="more-tip">More tip</h2>
<hr />

<p><a href="http://www.vogella.de/articles/EclipseMemoryAnalyser/article.html">Eclipse Memory Analyser (MAT) - Tutorial</a></p>

<p><a href="http://memoryanalyzer.blogspot.com/2010/01/heap-dump-analysis-with-memory-analyzer.html">Memory Analyzer Blog</a></p>

<p><a href="http://kohlerm.blogspot.com/search/label/memory">Java Performance blog</a></p>

<p>상기의 사이트들은 <a href="http://eclipse.org/mat/">MAT</a>과 Java의 메모리 처리에 관련된 내용을 포스팅한 사이트들입니다. 한 번 들러보면 좋은 정보를 얻을 수 있을것입니다.</p>

</div>


<div class="post-footer">
  <div class="back-btn"><a href="/">목록으로 돌아가기</a></div>
  <div class="fb-like" data-href="https://spoqa.github.io/2012/02/06/eclipse-mat.html" data-layout="button_count" data-width="" data-share="false" data-show-faces="false"></div>
  <div class="fb-comments" data-href="https://spoqa.github.io/2012/02/06/eclipse-mat.html" data-num-posts="5" data-width=""></div>
  <div id="fb-root"></div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function(event) {
    $('.fb-like, .fb-comments').attr('data-width', "100%");
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ko_KR/all.js#xfbml=1&appId=207542736008055";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
});
</script>
<style>
.hiring-banner {
  height: 320px;
  background-position-y: 80%;
}
.hiring-subtitle
{
  display: none;
}
.btn-job{
  margin-top: 4px;
}
@media only screen and (max-width: 360px) {
  .hiring-banner {
    height: 220px;
  }
}
}
</style>

    </div>
    <div class="push">
    </div>
    <div class="footer">
      <div id="info">
        <span>© <a href="http://cupeye.com/">컵아이</a> Inc. All rights reserved.</span>
        <span>Powered by <a href="https://pages.github.com/">GitHub Pages</a>.</span>
      </div>
    </div>
  </div>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="../../../js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    $(function() {
      $('.hiring-banner').bind("click", function() {
        location.href = '/jobs.html';
      });
      $('.toggle').bind("touchstart", function() {
        $('.menu').toggle();
      })
    });
  </script>
  <!-- Responsive layout polyfill for IE8 and lower -->
  <!--[if lte IE 8]>
  <script>
    var config = {
        mobileResponsiveBreakpoint: 650
    };
    $(window).on('resize', function(){
        if ($(window).width() <= config.mobileResponsiveBreakpoint) {
           !$(document.body).hasClass('res-mobile')) {
            $(document.body).addClass('res-mobile');
        } else {
            $(document.body).removeClass('res-mobile');
        }
    }).trigger('resize');
  </script>
  <![endif]-->
</body>
</html>
