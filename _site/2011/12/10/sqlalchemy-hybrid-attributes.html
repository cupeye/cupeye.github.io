<!doctype html>
<!--[if lt ie 7]>      <html class="lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if ie 7]>         <html class="lt-ie9 lt-ie8 ie7"> <![endif]-->
<!--[if ie 8]>         <html class="lt-ie9 ie8"> <![endif]-->
<!--[if gt ie 8]><!-->
<html class=""><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spoqa Tech Blog | SQLAlchemy의 Hybrid Attributes를 이용해서 MySQL에서의 위치정보를 깔끔하게 암호화하기</title>
  <link rel="canonical" href="https://spoqa.github.io/2011/12/10/sqlalchemy-hybrid-attributes.html">
  <meta property="og:title" content="SQLAlchemy의 Hybrid Attributes를 이용해서 MySQL에서의 위치정보를 깔끔하게 암호화하기">
  <meta property="og:url" content="https://spoqa.github.io/2011/12/10/sqlalchemy-hybrid-attributes.html">
  <meta property="og:site_name" content="컵아이">
  
  
  <meta property="og:type" content="article">
  <meta property="og:description" content="위치 기반 서비스(Location-based Service)를 국내에서 합법적으로 운영하기 위해선 등록위치정보의 저장을 전부 암호화해야 합니다. 저희는 SQLAlchemy의 Hybrid Attributes를 사용하여 위치정보를 암호화하였습니다.">
  
  
  <script>
    window.WebFontConfig = {
        custom: {
            families: ['spoqahansans:100,400,700'],
            urls: ['/css/spoqahansans.css']
        },
        timeout: 60000
    };
    (function(d) {
        var wf = d.createElement('script'), s = d.scripts[0];
        wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js';
        s.parentNode.insertBefore(wf, s);
    })(document);
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-36136046-5', 'auto');
    ga('send', 'pageview');
  </script>
  <link rel="stylesheet" href="../../../css/styles.css">
  <link href="../../../atom.xml" type="application/atom+xml" rel="alternate" title="Spoqa 기술 블로그">
  <link rel="shortcut icon" href="../../../images/favicon.ico">
  <style type="text/css">
@media only screen and (max-width: 580px) {
  .btn-job {
    display: none;
  }
}
</style>
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <div class="header-item">
        <div class="spoqa-logo-wrap">
          <a class="spoqa-logo" href="../../../"><img style="margin-top:-20px" src="../../../images/logo.png" alt="Spoqa logo"></a>
          <a class="blog-title" href="../../../">컵아이</a>
        </div>
        <div class="nav">
          <input type="checkbox" id="toggle">
          <label for="toggle" class="toggle" onclick></label>
          <ul class="menu">
            <li><a class="selected menu-about" href="../../../about.html">소개</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="content">
      


<div class="post-author-info">
  
    <img class="portrait" src="../../../images/profile/shinvee@spoqa.com.png" />
    <h1 class="post-title">SQLAlchemy의 Hybrid Attributes를 이용해서 MySQL에서의 위치정보를 깔끔하게 암호화하기</h1>
    <span class="post-date">2011년 12월 10일</span>
    <span class="sep">|</span>
    <span class="author-name"><a href="mailto:shinvee@spoqa.com">JC Kim</a></span>
  
</div>



  <div class="post"><p><strong><a href="http://ko.wikipedia.org/wiki/%EC%9C%84%EC%B9%98_%EA%B8%B0%EB%B0%98_%EC%84%9C%EB%B9%84%EC%8A%A4">위치 기반 서비스</a>(Location-based Service)</strong>를 국내에서 합법적으로 운영하기 위해선 위치기반 사업자 등록이 필요하다. 이 과정은 여러가지 보안사항에 대한 적용을 강제하고 있는데, 이 중 위치정보의 저장을 전부 암호화해야 한다는 조항이 있다.</p>

<p>이미 서비스를 어느정도 구현하여 운영중이라면 특히 이 조항이 매우 귀찮거나 부담되는 일일 수가 있다. 모든 위치정보 기록시점에서 암호화가 되어 저장되어야하고, 위치정보를 참조하거나 계산하는 시점에서 바로 복호화가 되어야 하기 때문이다.</p>

<p>스포카 개발팀은 이미 여러 곳에서 위치 정보를 암호화하지 않은 형태로 저장하고 불러오고 있었기 때문에, 기존 코드를 거의 유지하면서 위치정보 암호화를 투명하게 구현하기 위해 <a href="http://www.sqlalchemy.org/">SQLAlchemy</a>의 <a href="http://www.sqlalchemy.org/docs/orm/extensions/hybrid.html">Hybrid Attributes</a>를 사용하였다.</p>

<h2 id="sqlalchemy">SQLAlchemy?</h2>
<hr />

<p><a href="http://www.sqlalchemy.org/">SQLAlchemy</a>는 파이썬에서 이용할 수 있는 <a href="http://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a>으로, 상당히 고 수준의 인터페이스를 제공하여 완벽에 가까운 수준의 Object-Relation Mapping을 구현할 수 있게 도와준다.</p>

<h2 id="hybrid-attributes">Hybrid Attributes?</h2>
<hr />

<p>최근 0.7에선 <a href="http://www.sqlalchemy.org/docs/orm/extensions/hybrid.html">Hybrid Attributes</a>라는 것이 추가되었는데, 이 기능은 클래스가 정의한 속성이 사용 시점에 따라 파이썬 네이티브로, 혹은 같은 표현식의 SQL Query로도 이용할 수 있게 도와준다.</p>

<p>일반적인 클래스의 속성형이라면 이미 파이썬으로 가져온 엔티티에 한해서 이용할 수밖에 없으나, <a href="http://www.sqlalchemy.org/docs/orm/extensions/hybrid.html">Hybrid Attributes</a>를 이용하면 select query의 조건절같이 SQL 문법으로 변환되어야 하는 시점에서도 해당 속성 요소를 활용할 수 있다.</p>

<h2 id="section">방법</h2>
<hr />

<p>먼저 기존의 서비스는 엔티티에 위치 값을 저장시키기 위해 <strong>LocationMixIn</strong>이라는 클래스를 정의해놓고 필요한 엔티티 클래스가 이를 상속받게 하였다.</p>

<script src="https://gist.github.com/1452137.js?file=gistfile1.py">  </script>

<p>우리는 이를 실제로는 암호화해서 저장한 후, 참조하는 모든 환경에서 다시 원래 값으로 복호화하는 hybrid property를 구현하고 이로  구성된 새로운 클래스로 기존 LocationMixIn을 교체할 것이다.</p>

<h3 id="mysql-aes------">1. MySQL의 AES 암호화 알고리즘과 호환되는 암호화 알고리즘 구현</h3>
<hr />
<p>MySQL에선 AES 압축 알고리즘이 기본으로 제공되며 이는 각각 AES_ENCRYPT, AES_DECRYPT이다. 해당 함수들이 알고리즘을 설명한 <a href="http://dev.mysql.com/doc/refman/5.5/en/encryption-functions.html#function_aes-encrypt">스펙문서</a>에 따라 python에서 구현해주면 된다.</p>

<script src="https://gist.github.com/1452269.js?file=gistfile1.py">  </script>

<h3 id="locationmixin----">2. 기존 LocationMixIn을 대체할 새로운 클래스 정의</h3>
<hr />
<p>준비가 되었다면 이제 새로운 <strong>EncryptedLocationMixIn</strong>을 만들어보자. 아래와 같이 암호화된 값을 받을 공간을 할당받게 먼저 구성한다.</p>

<script src="https://gist.github.com/1452328.js?file=gistfile1.py">  </script>

<p>하나의 위치 정보 속성에 대한 hybrid property를 구현하기 위해 세가지 함수를 정의한다.</p>

<script src="https://gist.github.com/1452349.js?file=gistfile1.py">  </script>

<p>lat 이라는 함수가 암호화된 lat을 복호화해서 반환하게 구현한 후 이를 <strong>@hybrid_property</strong>로 만든다.</p>

<script src="https://gist.github.com/1452370.js?file=gistfile1.py">  </script>

<p>기본 수식 정도는 hybrid_property 선언만으로 자연스럽게 SQL 표현식으로 변환이 되지만, 우리는 지원하지 않는 MySQL built-in function을 이용하고 있기 때문에 위와 같이 복호화에 대한 SQL expression을 새로 구현해준다. <a href="http://www.sqlalchemy.org/docs/core/expression_api.html#sqlalchemy.sql.expression.func"><strong>sqlalchemy.sql.expression.func</strong></a>는 SQL function을 표현할 수 있게 해주는 객체 인스턴스이다.</p>

<script src="https://gist.github.com/1452406.js?file=gistfile1.py">  </script>

<p>마지막으로 값이 저장될 때 암호화되어 저장될 수 있도록 한다. 16자로 자르는 이유는 위치 값이 그보다 길어질 때 암호화된 값이 잘려서 들어갈 위험을 방지하기 위해서이다.</p>

<p><strong>lng</strong>도 마찬가지로 구현해주면 된다.</p>

<h3 id="locationmixin-">3. 기존의 LocationMixIn을 교체</h3>
<hr />
<p>현재 만든 <strong>EncryptedLocationMixIn</strong>은 MySQL의 built-in function을 이용하기 때문에 다른 DB에서는 작동하지 않을 것이다. 우리는 프로덕션 서비스에서만 암호화되어 작동되면 되므로 EncryptedLocationMixIn을 mysql 연결시에만 교체하도록 하였다.</p>

<script src="https://gist.github.com/1452426.js?file=gistfile1.py">  </script>

<p>이와 같이 하면 SQLite와 같은 DB에선 평범하게 값이 저장이 되고, MySQL에서만 암호화되어 저장되게 된다.</p>

<h2 id="section-1">장점</h2>
<hr />
<p>hybrid property를 이용해서 위치정보를 암호화하면, 암호화된 위치정보를 어떤 상황에서든 암호화되지 않은 위치정보를 다루듯이 이용할 수 있다는 것이 장점이다.</p>

<script src="https://gist.github.com/1452468.js?file=gistfile1.py">  </script>

<p>이와 같이 가져온 객체의 위치값을 바로 복호화해서 받아내며,</p>

<script src="https://gist.github.com/1452483.js?file=gistfile1.py">  </script>

<p>이와 같이 숫자 계산과 비교를 하는 조건절에도 대응을 할 수 있다. 첫째 줄과 컴파일된 WHERE절을 비교해보자.</p>

<p>이러한 방식을 통해 <a href="http://www.spoqa.com/">스포카</a>는 기존의 핸들러/모델 메서드들이 위치값에 접근하기 위해 구현된 코드를 건드리지 않으면서, 저장되는 위치정보를 성공적으로 암호화할 수 있었다.</p>

</div>


<div class="post-footer">
  <div class="back-btn"><a href="/">목록으로 돌아가기</a></div>
  <div class="fb-like" data-href="https://spoqa.github.io/2011/12/10/sqlalchemy-hybrid-attributes.html" data-layout="button_count" data-width="" data-share="false" data-show-faces="false"></div>
  <div class="fb-comments" data-href="https://spoqa.github.io/2011/12/10/sqlalchemy-hybrid-attributes.html" data-num-posts="5" data-width=""></div>
  <div id="fb-root"></div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function(event) {
    $('.fb-like, .fb-comments').attr('data-width', "100%");
    (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ko_KR/all.js#xfbml=1&appId=207542736008055";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
});
</script>
<style>
.hiring-banner {
  height: 320px;
  background-position-y: 80%;
}
.hiring-subtitle
{
  display: none;
}
.btn-job{
  margin-top: 4px;
}
@media only screen and (max-width: 360px) {
  .hiring-banner {
    height: 220px;
  }
}
}
</style>

    </div>
    <div class="push">
    </div>
    <div class="footer">
      <div id="info">
        <span>© <a href="http://cupeye.com/">컵아이</a> Inc. All rights reserved.</span>
        <span>Powered by <a href="https://pages.github.com/">GitHub Pages</a>.</span>
      </div>
    </div>
  </div>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="../../../js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    $(function() {
      $('.hiring-banner').bind("click", function() {
        location.href = '/jobs.html';
      });
      $('.toggle').bind("touchstart", function() {
        $('.menu').toggle();
      })
    });
  </script>
  <!-- Responsive layout polyfill for IE8 and lower -->
  <!--[if lte IE 8]>
  <script>
    var config = {
        mobileResponsiveBreakpoint: 650
    };
    $(window).on('resize', function(){
        if ($(window).width() <= config.mobileResponsiveBreakpoint) {
           !$(document.body).hasClass('res-mobile')) {
            $(document.body).addClass('res-mobile');
        } else {
            $(document.body).removeClass('res-mobile');
        }
    }).trigger('resize');
  </script>
  <![endif]-->
</body>
</html>
